# AI Chat API å¯¹æ¯”è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

é¡¹ç›®ç°åœ¨æä¾›ä¸¤ç§AIå¯¹è¯APIï¼š

1. **POSTè¯·æ±‚æ¨¡å¼** (`/api/ai/chat`) - ä¼ ç»Ÿçš„é˜»å¡å¼è¯·æ±‚
2. **SSEæµå¼æ¨¡å¼** (`/api/ai/chat2`) - å®æ—¶æµå¼ä¼ è¾“

## ğŸ” ä¸¤ç§æ¨¡å¼çš„è¯¦ç»†å¯¹æ¯”

### 1. POST è¯·æ±‚æ¨¡å¼ (`/api/ai/chat`)

**ç‰¹ç‚¹ï¼š**
- âœ… é˜»å¡å¼å“åº”ï¼šç­‰å¾…AIå®Œæˆå…¨éƒ¨ç”Ÿæˆåä¸€æ¬¡æ€§è¿”å›
- ğŸ“¦ JSONæ ¼å¼ï¼šç»“æ„åŒ–æ•°æ®ï¼Œæ˜“äºè§£æå’Œå¤„ç†
- â±ï¸ ç­‰å¾…æ—¶é—´ï¼šè¾ƒé•¿ï¼Œç”¨æˆ·åœ¨ç­‰å¾…æœŸé—´çœ‹ä¸åˆ°ä»»ä½•è¿›å±•
- ğŸ¯ é€‚ç”¨åœºæ™¯ï¼šç®€çŸ­å¯¹è¯ã€å¿«é€ŸæŸ¥è¯¢ã€éœ€è¦å®Œæ•´JSONç»“æ„çš„åœºæ™¯

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```bash
curl -X POST http://localhost:8080/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"}'
```

**å“åº”æ ¼å¼ï¼š**
```json
{
  "trace_id": "xxx",
  "code": 0,
  "message": "success",
  "data": {
    "reply": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ¸©åº¦20Â°Cï¼Œæ¹¿åº¦45%..."
  }
}
```

---

### 2. SSE æµå¼æ¨¡å¼ (`/api/ai/chat2`)

**ç‰¹ç‚¹ï¼š**
- âš¡ å®æ—¶ä¼ è¾“ï¼šè¾¹ç”Ÿæˆè¾¹è¿”å›ï¼Œç”¨æˆ·ç«‹å³çœ‹åˆ°ç»“æœ
- ğŸŒŠ äº‹ä»¶æµï¼šä½¿ç”¨Server-Sent Eventsï¼Œå•å‘æ¨é€
- âœ¨ ç”¨æˆ·ä½“éªŒï¼šç±»ä¼¼ChatGPTçš„æ‰“å­—æœºæ•ˆæœ
- ğŸ“ é€‚ç”¨åœºæ™¯ï¼šé•¿æ–‡æœ¬ç”Ÿæˆã€AIå¯¹è¯ã€éœ€è¦å®æ—¶åé¦ˆçš„åœºæ™¯

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```bash
curl -X POST http://localhost:8080/api/ai/chat2 \
  -H "Content-Type: application/json" \
  -d '{"message": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"}' \
  -N
```

**å“åº”æ ¼å¼ï¼ˆSSEæµï¼‰ï¼š**
```
data: {"content": "åŒ—äº¬"}

data: {"content": "ä»Šå¤©"}

data: {"content": "å¤©æ°”"}

data: {"content": "æ™´æœ—"}

data: {"finish_reason": "stop"}
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æ–¹æ³•1ï¼šå‘½ä»¤è¡Œæµ‹è¯•è„šæœ¬

```bash
chmod +x test_sse_comparison.sh
./test_sse_comparison.sh
```

è¿™ä¸ªè„šæœ¬ä¼šä¾æ¬¡æµ‹è¯•ä¸¤ç§APIï¼Œå¹¶æ˜¾ç¤ºæ—¶é—´å¯¹æ¯”ã€‚

### æ–¹æ³•2ï¼šç½‘é¡µå¯è§†åŒ–æµ‹è¯•ï¼ˆæ¨èï¼‰

1. å¯åŠ¨æœåŠ¡ï¼š
```bash
./run.sh
```

2. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š
```
file:///ç»å¯¹è·¯å¾„/hi-go/test_sse_client.html
```

æˆ–è€…ä½¿ç”¨ç®€å•çš„HTTPæœåŠ¡å™¨ï¼š
```bash
python3 -m http.server 8000
# ç„¶åè®¿é—® http://localhost:8000/test_sse_client.html
```

ç½‘é¡µæµ‹è¯•ç•Œé¢æä¾›ï¼š
- ğŸ“Š å·¦å³å¯¹æ¯”ï¼šåŒæ—¶æµ‹è¯•ä¸¤ç§API
- â±ï¸ æ€§èƒ½ç»Ÿè®¡ï¼šå“åº”æ—¶é—´ã€TTFBã€æ•°æ®å—æ•°é‡
- âœ¨ å¯è§†åŒ–æ•ˆæœï¼šæ¸…æ™°çœ‹åˆ°SSEçš„æ‰“å­—æœºæ•ˆæœ
- ğŸ“ˆ å®æ—¶è¿›åº¦ï¼šSSEè¯·æ±‚å¯ä»¥çœ‹åˆ°å†…å®¹é€æ­¥ç”Ÿæˆ

### æ–¹æ³•3ï¼šä½¿ç”¨curlç›´æ¥æµ‹è¯•

**æµ‹è¯•POSTï¼š**
```bash
curl -X POST http://localhost:8080/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ä½ å¥½"}' | jq
```

**æµ‹è¯•SSEï¼š**
```bash
curl -X POST http://localhost:8080/api/ai/chat2 \
  -H "Content-Type: application/json" \
  -d '{"message": "ä½ å¥½"}' \
  -N
```

---

## ğŸ’¡ å…³é”®æŠ€æœ¯å®ç°

### SSEå®ç°è¦ç‚¹

1. **HTTPå“åº”å¤´è®¾ç½®ï¼š**
```go
c.Header("Content-Type", "text/event-stream")
c.Header("Cache-Control", "no-cache")
c.Header("Connection", "keep-alive")
c.Header("X-Accel-Buffering", "no") // ç¦ç”¨nginxç¼“å†²
```

2. **æµå¼è¯»å–DeepSeekå“åº”ï¼š**
```go
// å¯ç”¨streamæ¨¡å¼
reqBody["stream"] = true

// é€è¡Œè¯»å–SSEæµ
reader := &sseReader{reader: resp.Body}
for {
    line, err := reader.readLine()
    // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
}
```

3. **é€šè¿‡channelä¼ é€’æ•°æ®ï¼š**
```go
streamChan := make(chan StreamResponse, 10)
go func() {
    // è¯»å–SSEå¹¶å‘é€åˆ°channel
    for {
        streamChan <- response
    }
}()
return streamChan, nil
```

4. **Ginçš„StreamåŠ©æ‰‹ï¼š**
```go
c.Stream(func(w io.Writer) bool {
    if resp, ok := <-streamChan; ok {
        c.SSEvent("message", data)
        c.Writer.Flush()
        return true // ç»§ç»­è¯»å–
    }
    return false // ç»“æŸæµ
})
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

å…¸å‹åœºæ™¯æµ‹è¯•ï¼ˆæŸ¥è¯¢å¤©æ°”ï¼‰ï¼š

| æŒ‡æ ‡ | POSTæ¨¡å¼ | SSEæ¨¡å¼ |
|-----|---------|---------|
| é¦–å­—èŠ‚æ—¶é—´(TTFB) | ~2000ms | ~500ms |
| æ€»å“åº”æ—¶é—´ | ~2000ms | ~2000ms |
| ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ | âŒ é«˜ï¼ˆéœ€ç­‰å¾…ï¼‰ | âœ… ä½ï¼ˆç«‹å³å¯è§ï¼‰ |
| é€‚åˆé•¿æ–‡æœ¬ | âŒ å¦ | âœ… æ˜¯ |
| å®ç°å¤æ‚åº¦ | âœ… ç®€å• | âš ï¸ ä¸­ç­‰ |

**ç»“è®ºï¼š**
- SSEæ¨¡å¼çš„æ€»æ—¶é—´å¯èƒ½ç›¸åŒï¼Œä½†**é¦–å­—èŠ‚æ—¶é—´**æ›´çŸ­
- ç”¨æˆ·**æ„ŸçŸ¥åˆ°çš„ç­‰å¾…æ—¶é—´**å¤§å¹…å‡å°‘
- å¯¹äºé•¿æ–‡æœ¬ç”Ÿæˆï¼ŒSSEæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

## ğŸ”§ é…ç½®è¯´æ˜

ä¸¤ç§APIå…±äº«ç›¸åŒçš„é…ç½®æ–‡ä»¶ `configs/dev.yaml`ï¼š

```yaml
ai:
  enabled: true
  provider: deepseek
  model: deepseek-chat
  api_key: sk-xxx
  base_url: https://api.deepseek.com
  timeout: 30
  max_tokens: 4000
  temperature: 0.7
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šSSEè¿æ¥ç«‹å³æ–­å¼€
- æ£€æŸ¥nginxé…ç½®ï¼Œç¡®ä¿ç¦ç”¨ç¼“å†²ï¼š`proxy_buffering off;`
- ç¡®ä¿è®¾ç½®äº† `X-Accel-Buffering: no` å¤´

### é—®é¢˜2ï¼šSSEæ•°æ®ä¸å®æ—¶
- æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº† `c.Writer.Flush()`
- ç¡®ä¿æ¯æ¬¡å‘é€åéƒ½åˆ·æ–°ç¼“å†²åŒº

### é—®é¢˜3ï¼šæµè§ˆå™¨æ— æ³•æ¥æ”¶SSE
- æ£€æŸ¥CORSè®¾ç½®
- ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networkæ ‡ç­¾ï¼ŒæŸ¥çœ‹EventStream

### é—®é¢˜4ï¼šPOSTè¯·æ±‚æ­£å¸¸ä½†SSEå¤±è´¥
- æ£€æŸ¥DeepSeek API keyæ˜¯å¦æœ‰æ•ˆ
- æŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æ”¯æŒstreamæ¨¡å¼
- æŸäº›AIæ¨¡å‹å¯èƒ½ä¸æ”¯æŒæµå¼è¾“å‡º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Server-Sent Events (SSE) è§„èŒƒ](https://html.spec.whatwg.org/multipage/server-sent-events.html)
- [DeepSeek API æ–‡æ¡£](https://platform.deepseek.com/docs)
- [Gin Stream æ–‡æ¡£](https://gin-gonic.com/docs/examples/http-streaming/)

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **å·¥å…·è°ƒç”¨æ”¯æŒ**ï¼šå½“å‰SSEæ¨¡å¼æœªå®Œæ•´å®ç°å·¥å…·è°ƒç”¨çš„æµå¼å¤„ç†
2. **é‡è¿æœºåˆ¶**ï¼šæ·»åŠ SSEçš„è‡ªåŠ¨é‡è¿æ”¯æŒ
3. **æ¶ˆæ¯å‹ç¼©**ï¼šå¯¹é•¿æ–‡æœ¬è¿›è¡Œgzipå‹ç¼©
4. **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶åŒæ—¶è¿›è¡Œçš„SSEè¿æ¥æ•°
5. **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿æŒ

---

## ğŸ“ æ€»ç»“

é€‰æ‹©å“ªç§APIå–å†³äºä½ çš„ä½¿ç”¨åœºæ™¯ï¼š

- **éœ€è¦å¿«é€Ÿç®€å•çš„é›†æˆ** â†’ ä½¿ç”¨ POST æ¨¡å¼
- **éœ€è¦æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ** â†’ ä½¿ç”¨ SSE æ¨¡å¼
- **ç”Ÿæˆé•¿æ–‡æœ¬å†…å®¹** â†’ ä¼˜å…ˆä½¿ç”¨ SSE æ¨¡å¼
- **ç®€çŸ­é—®ç­”** â†’ POST æ¨¡å¼è¶³å¤Ÿ

å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­**åŒæ—¶æä¾›ä¸¤ç§API**ï¼Œè®©å®¢æˆ·ç«¯æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å¼ã€‚
